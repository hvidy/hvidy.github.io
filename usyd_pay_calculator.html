<!DOCTYPE html>

<html lang="en">
<head>

    <!-- Basic Page Needs–––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>USyd EBA Pay Offer Calculator</title>
    <meta name="description" content="">

    <!-- CSS–––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="new.css">
    
    <!-- Scripts–––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <!-- <script type="text/javascript" src="js/utils.js"></script> -->
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<!--     <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
        <script
        src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
        crossorigin="anonymous"></script>
 -->    <!-- <script type="text/javascript" src="js/plotly-latest.min.js"></script> -->
    
    <!-- Favicon  -->
    <link rel="icon" type="image/jpg" href="icon.jpg">
    
</head>

<body>
  <!-- Primary Page Layout–––––––––––––––––––––––––––––––––––––––––––––––––– -->

<h1>Pay Offer Calculator &mdash; University of Sydney</h1>

  <div id="barplots">
    <div class="barplot", data-num="0">
      <div class="control-row">
        <p>Pay Grade: <select class="payleveldata"></select></p>
      </div>
      <div class="plot" id="content"></div>
    </div>
  </div>

</body>


<!-- <div>
  <ul class="ruler" id="mydiv" data-items="10"></ul>
</div>
 -->

<!-- <div>
  <div class="slidecontainer">
    <input type="range" min="1" max="15" value="1" class="slider" id="spacing" step=0.25>
  </div>
</div>

 -->
<!-- Scripts! ––––––––––––––––––––––––––––––––––––––––––––––––––-->
<script>

//Called when the program first opens
// window.onload = function() {

  //Instantiate the chart and bind it to content html
  // var graphDiv = document.getElementById('content');

  var date_df = 'data/dates.csv';
  var xDateSeriesName = 'date';
  var yDateSeriesName = 'idx';

  var salary_df = 'data/pay_levels.csv';

  var d3 = Plotly.d3;

  var gd3 = d3.select("div[id='content']");

  var content = gd3.node();

  Plotly.d3.csv(salary_df, function(err, rows){

    function unpack(rows, key) {
      return rows.map(function(row) {return row[key];});
    }

    var allPay = unpack(rows,'salary'),
        allPayLevels = unpack(rows,'code'),
        listofPayLevels = [],
        currentPayLevel,
        currentPay = [],
        dates = [];


    for (var i = 0; i < allPayLevels.length; i++){
      if (listofPayLevels.indexOf(allPayLevels[i]) === -1){
        listofPayLevels.push(allPayLevels[i]);
      }
    }

    function getPayLevelData(chosenPayLevel) {
      currentPay = [];
      currentPayLevel = chosenPayLevel
      for (var i = 0; i < allPayLevels.length; i++){
        if (allPayLevels[i] === chosenPayLevel) {
          currentPay.push(allPay[i]);
        }
      }
    };

    function getDateData() {
      Plotly.d3.csv(date_df, function(data){

        processData(data,xDateSeriesName)


      });
    }

    function processData(allRows,xLabel) {
      var dates =[];

      for (var i = 0; i < allRows.length; i++) {
        row = allRows[i]
        dates.push(row[xLabel]);
      }

      var payments = [];
      var today = new Date().toISOString().slice(0,10);
      for (var i = 0; i < dates.length; i++) {
        pay = currentPay
        if (dates[i] > '2022-07-02') {
          pay = Math.round(pay*1.02)
        }
        if (dates[i] > today) {
          pay = Math.round(pay*1.046)
        }
        if (dates[i] > '2024-07-01') {
          pay = Math.round(pay*1.0325)
        }
        if (dates[i] > '2025-07-01') {
          pay = Math.round(pay*1.0325)
        }
        if (dates[i] > '2026-07-01') {
          pay = Math.round(pay*1.035)
        }
        fortnight_pay = pay/365.25*14
        payments.push(fortnight_pay.toFixed(2));
      }

      var inflation_payments = []
      for (var i = 0; i < dates.length; i++) {
        pay = currentPay
        if (dates[i] > '2022-07-01') {
          pay = Math.round(pay*1.061)
        }
        if (dates[i] > '2023-07-01') {
          pay = Math.round(pay*1.067)
        }
        if (dates[i] > '2024-07-01') {
          pay = Math.round(pay*1.036)
        }
        if (dates[i] > '2025-07-01') {
          pay = Math.round(pay*1.03)
        }
        if (dates[i] > '2026-07-01') {
          pay = Math.round(pay*1.025)
        }
        fortnight_pay = pay/365.25*14
        inflation_payments.push(fortnight_pay.toFixed(2));
      }

      var wsu_payments = []
      for (var i = 0; i < dates.length; i++) {
        pay = currentPay
        if (dates[i] > '2022-04-29') {
          pay = Math.round(pay*1.02)
        }
        if (dates[i] > '2022-10-14') {
          pay = Math.round(pay*1.026)
        }
        if (dates[i] > '2023-10-01') {
          pay = Math.round(pay*1.0335)
        }
        if (dates[i] > '2024-10-01') {
          pay = Math.round(pay*1.029)
        }
        if (dates[i] > '2025-03-01') {
          pay = Math.round(pay*1.026)
        }
        fortnight_pay = pay/365.25*14
        wsu_payments.push(fortnight_pay.toFixed(2));
      }    

      var utas_payments = []
      for (var i = 0; i < dates.length; i++) {
        pay = currentPay
        if (dates[i] > '2022-07-06') {
          pay = Math.round(pay*1.046)
        }
        if (dates[i] > '2023-07-01') {
          pay = Math.round(pay*1.03)
        }
        if (dates[i] > '2024-07-01') {
          pay = Math.round(pay*1.025)
        }
        if (dates[i] > '2025-06-15') {
          pay = Math.round(pay*1.034)
        }
        fortnight_pay = pay/365.25*14
        utas_payments.push(fortnight_pay.toFixed(2));
      }

      var uplift = 0
      if (currentPayLevel.slice(0,1) == 'A'){
        uplift = 1000
      } 
      if (currentPayLevel.slice(0,1) == 'H'){
        if (currentPayLevel.slice(3,6) < 6){
          uplift = 1000
        }
        if (currentPayLevel.slice(3,6) > 6 && currentPayLevel.slice(3,6) < 8){
          uplift = 500
        }
      }
      console.log(currentPayLevel.slice(0,1))
      console.log(currentPayLevel.slice(3,6))
      console.log(uplift)

      var acu_payments = []
      for (var i = 0; i < dates.length; i++) {
        pay = currentPay
        if (dates[i] > '2022-07-09') {
          pay = Math.round(pay*1.022)
        }
        if (dates[i] > '2023-01-01') {
          pay = Math.round((pay+uplift)*1.028)
        }
        if (dates[i] > '2024-01-01') {
          pay = Math.round(pay*1.0375)
        }
        if (dates[i] > '2025-01-01') {
          pay = Math.round(pay*1.03)
        }
        if (dates[i] > '2025-06-30') {
          pay = Math.round(pay*1.028)
        }
        fortnight_pay = pay/365.25*14
        acu_payments.push(fortnight_pay.toFixed(2));
      }

      var trace1 = {
        x: dates,
        y: payments,
        name: 'USyd Offer',
        mode: 'bar'
      };

      var trace2 = {
        x: dates,
        y: inflation_payments,
        name: 'Predicted CPI',
        mode: 'bar'
      };

      var trace3 = {
        x: dates,
        y: wsu_payments,
        name: 'WSU Agreement',
        mode: 'bar'
      };

      var trace4 = {
        x: dates,
        y: utas_payments,
        name: 'UTas Agreement',
        mode: 'bar'
      };

      var trace5 = {
        x: dates,
        y: acu_payments,
        name: 'ACU Agreement',
        mode: 'bar'
      };

      var data = [trace1, trace2, trace3, trace4, trace5];

      var layout = {
        xaxis:{
          title: 'Pay date'
        },
        yaxis:{
          title: 'Gross pay per fortnight ($)',
          // rangemode: 'tozero',
          autorange: true
        }
      }

      Plotly.newPlot('content', data, layout)

    }

    //Default Pay Level
    setBarPlot('A1');

    function setBarPlot(chosenPayLevel) {
      getPayLevelData(chosenPayLevel);
      getDateData();


  };

  var innerContainer = document.querySelector('[data-num="0"'),
      plotEl = innerContainer.querySelector('.plot'),
      payLevelSelector = innerContainer.querySelector('.payleveldata');

  function assignOptions(textArray, selector) {
    for (var i = 0; i < textArray.length; i++) {
      var currentOption = document.createElement('option');
      currentOption.text = textArray[i];
      selector.appendChild(currentOption);
    }
  }

  assignOptions(listofPayLevels, payLevelSelector);

  function updatePayLevel(){
    setBarPlot(payLevelSelector.value);
  }

  payLevelSelector.addEventListener('change', updatePayLevel, false);


  });


//instruction resizes plot
window.onresize = function() {
  Plotly.Plots.resize(content);
};


</script>

<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
</html>